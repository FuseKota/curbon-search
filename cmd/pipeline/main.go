// =============================================================================
// main.go - Carbon Relay ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
// =============================================================================
//
// ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€ã‚«ãƒ¼ãƒœãƒ³ãƒ‹ãƒ¥ãƒ¼ã‚¹åŽé›†ãƒ»é…ä¿¡ã‚’è‡ªå‹•åŒ–ã™ã‚‹CLIãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
//
// =============================================================================
// ã€ä¸»ãªæ©Ÿèƒ½ã€‘
// =============================================================================
//
// ðŸŸ¢ ç„¡æ–™è¨˜äº‹åŽé›†ãƒ¢ãƒ¼ãƒ‰
//
//	â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
//	â”‚ ç›®çš„:     è¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰è¨˜äº‹ã‚’ç›´æŽ¥åŽé›†                         â”‚
//	â”‚ ã‚³ã‚¹ãƒˆ:   ç„¡æ–™                                                   â”‚
//	â”‚ é€Ÿåº¦:     5-15ç§’                                                 â”‚
//	â”‚ å‡ºåŠ›:     JSONã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡                                       â”‚
//	â”‚ ã‚³ãƒžãƒ³ãƒ‰: ./pipeline -sources=carbonpulse -perSource=10         â”‚
//	â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//
// =============================================================================
// ã€å‡¦ç†ãƒ•ãƒ­ãƒ¼ã€‘
// =============================================================================
//
//	â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
//	â”‚  1. è¨­å®š    â”‚ -> â”‚  2. åŽé›†    â”‚ -> â”‚  3. å‡ºåŠ›    â”‚
//	â”‚  èª­ã¿è¾¼ã¿   â”‚    â”‚  ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ” â”‚    â”‚  JSON/Mail  â”‚
//	â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//	       â”‚                  â”‚                  â”‚
//	       v                  v                  v
//	.envèª­ã¿è¾¼ã¿        å„ã‚½ãƒ¼ã‚¹ã‹ã‚‰      JSONå‡ºåŠ› or
//	CLIãƒ•ãƒ©ã‚°è§£æž       è¦‹å‡ºã—åŽé›†        ãƒ¡ãƒ¼ãƒ«é€ä¿¡
//
// =============================================================================
// ã€CLIãƒ•ãƒ©ã‚°ä¸€è¦§ã€‘
// =============================================================================
//
// â–¼ åŸºæœ¬è¨­å®š
//
//	-headlines       æ—¢å­˜ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¦‹å‡ºã—ã‚’èª­ã¿è¾¼ã‚€
//	-out             å‡ºåŠ›JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆçœç•¥æ™‚: stdoutï¼‰
//	-sources         åŽé›†ã™ã‚‹ã‚½ãƒ¼ã‚¹ï¼ˆã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šï¼‰
//	-perSource       ã‚½ãƒ¼ã‚¹ã‚ãŸã‚Šã®æœ€å¤§è¨˜äº‹æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 30ï¼‰
//
// â–¼ ãƒ¡ãƒ¼ãƒ«è¨­å®š
//
//	-sendEmail       ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ¢ãƒ¼ãƒ‰
//	-sendShortEmail  50æ–‡å­—ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆé€ä¿¡
//	-notionClip      Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
//
// =============================================================================
// ã€åˆå¿ƒè€…å‘ã‘ãƒã‚¤ãƒ³ãƒˆã€‘
// =============================================================================
//
// - flag ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§CLIå¼•æ•°ã‚’è§£æž
// - godotenv ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
// - ã‚¨ãƒ©ãƒ¼ã¯æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ï¼ˆos.Stderrï¼‰ã«å‡ºåŠ›
// - å‡¦ç†ã®é€²æ—ã‚‚æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«å‡ºåŠ›ï¼ˆstdoutã¯JSONã®ã¿ï¼‰
//
// =============================================================================
package main

import (
	"github.com/joho/godotenv" // .env ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
)

// main ã¯ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å…¨ä½“ã®åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼
//
// ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å‡¦ç†ã®æ¦‚è¦:
//  1. å„ã‚½ãƒ¼ã‚¹ã‹ã‚‰è¦‹å‡ºã—åŽé›†
//  2. çµæžœã‚’JSONå‡ºåŠ›ã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«é€ä¿¡
func main() {
	// .env ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
	// ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ãŒã€å‡¦ç†ã¯ç¶šè¡Œã™ã‚‹
	if err := godotenv.Load(); err != nil {
		warnf(".env file not loaded: %v (using environment variables only)", err)
	}

	// CLIãƒ•ãƒ©ã‚°ã‚’è§£æžï¼ˆconfig.goã®ParseFlagsï¼‰
	cfg := ParseFlags()

	// --- Early exit for email-only modes ---
	if cfg.Email.SendEmail {
		handleEmailSend(cfg.Email.DaysBack)
		return
	}
	if cfg.Email.SendShortEmail {
		handleShortEmailSend(cfg.Email.DaysBack)
		return
	}
	if cfg.Email.ListShortHeadlines {
		handleListShortHeadlines(cfg.Email.DaysBack)
		return
	}

	// --- 1) Collect or read headlines ---
	var headlines []Headline
	if cfg.Input.HeadlinesFile != "" {
		if err := readJSONFile(cfg.Input.HeadlinesFile, &headlines); err != nil {
			fatalf("reading headlines: %v", err)
		}
	} else {
		headlineCfg := defaultHeadlineConfig()
		// ã‚½ãƒ¼ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’ä½¿ç”¨ã—ã¦åŽé›†ï¼ˆheadlines.goã®CollectFromSourcesã‚’å‘¼ã³å‡ºã—ï¼‰
		var err error
		headlines, err = CollectFromSources(cfg.Input.Sources(), cfg.Input.PerSource, headlineCfg)
		if err != nil {
			fatalf("collecting headlines: %v", err)
		}
	}

	if len(headlines) == 0 {
		fatalf("no headlines collected")
	}

	// --- 1.5) Filter by hours if specified ---
	if cfg.Input.HoursBack > 0 {
		headlines = FilterHeadlinesByHours(headlines, cfg.Input.HoursBack)
		if len(headlines) == 0 {
			fatalf("no headlines after filtering by %d hours", cfg.Input.HoursBack)
		}
	}

	// --- 2) Output results ---
	handleJSONOutput(headlines, &cfg.Output)

	// --- 3) Clip to Notion (if enabled) ---
	if cfg.Output.NotionClip {
		handleNotionClip(headlines, &cfg.Output)
	}
}

// Handlers are defined in handlers.go:
// - handleEmailSend
// - handleShortEmailSend
// - handleListShortHeadlines
// - handleJSONOutput
// - handleNotionClip
